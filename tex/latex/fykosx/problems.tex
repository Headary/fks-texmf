%
% @author Michal Koutný <michal@fykos.cz>
%
% @description Auxiliary macros for reading problems database
%              and formatting its output.
%

\RequirePackage{ifthen}
% cooperation with fksfigures input@path change
\ifx\@problemsdir\@undefined
\def\@problemsdir{.}
\fi
\renewcommand\@problemsdir{.}
\newcommand\problemsdir[1]{\renewcommand\@problemsdir{#1}}

% problems
\newcommand\@tmpfilename{}
\newcommand\@LoadProblem[3]{ % batch number, problem number, expansion code
  \renewcommand\@tmpfilename{\@problemsdir/problem#1-#2.tex}
  \probfig{N/A}\probsolvers{N/A}\probavg{N/A}
  \IfFileExists{\@tmpfilename}{
  \input{\@tmpfilename}%
  \ClassInfo{fksserie}{Loaded \@tmpfilename}
  #3
  }{\ClassWarning{fksserie}{Problem file \@tmpfilename not found.}}
}

\newcommand\problemtask{%
  \stepcounter{problem}%
  \@LoadProblem{\thebatch}{\theproblem}{%
   \problem[\metaprobletter{problem}: \@probname]{Úloha \Roman{batch}.\metaprobletter{problem} \ldots{} \@probname{} \hfill {\normalfont\normalsize\@probpoints~\plural{\@probpoints}{bod}{body}{bodů}}}%
   \ifthenelse{\equal{\@probfig}{N/A}}{}{\@probfig}
   \@probtask%
  }
}

\newcommand\problemsolution{%
  \stepcounter{problem}%
  \@LoadProblem{\thesolvedbatch}{\theproblem}{%
  \pr@blemsolution
}}

\newcommand\myprint[1]{pdfauthor=#1}
\def\expandargument#1#2{%
    \edef\temp{#2}%
    \expandafter#1\expandafter{\temp}%
}

\newcommand\problemsolutionsingle{%
  \setcounter{solvedbatch}{\@probbatch}
  \setcounter{problem}{\@probno}
  \hypersetup{
    pdftitle={\met@shortname, \Roman{year}.\Roman{solvedbatch}.\arabic{problem} \@probname},
    pdfauthor={\@probsolauthors},
  }

  \pr@blemsolution
}

\newcommand\pr@blemsolution{%  
   \problem[\metaprobletter{problem}: \@probname]%
    {Úloha \Roman{solvedbatch}.\metaprobletter{problem} \ldots{} \@probname{} \hfill
      {\normalfont\normalsize\@probpoints~\plural{\@probpoints}{bod}{body}{bodů},
       \ifthenelse{\equal\@probavg{N/A}}{(chybí statistiky)\PackageWarning{fks problems}{Missing stats for problem \Roman{solvedbatch}.\theproblem.}}{%
       průměr \@probavg,
       \plural{\@probsolvers}{řešil}{řešili}{řešilo}{} \@probsolvers{} \plural{\@probsolvers}{student}{studenti}{studentů}}}}%
   \ifthenelse{\equal{\@probfig}{N/A}}{}{\@probfig}   
   \textsl{\@probtask}
   
   
   \hfill \textit{\@proborigin} %TODO zarovnat doprava jako u citace

   \medskip
   
   \noindent \@probsolution

  \expandafter\signature\@probsolauthors
}


% problem attributes
\newcommand\@probbatch{N/A}
\newcommand\@probno{N/A}
\newcommand\@probname{N/A}
\newcommand\@proborigin{N/A}
\newcommand\@probpoints{N/A}
\newcommand\@probsolauthors{N/A}
\newcommand\@probsolvers{N/A}
\newcommand\@probavg{N/A}
\newcommand\@probtask{N/A}
\newcommand\@probsolution{N/A}
\newcommand\@probfig{N/A}

\newcommand\probbatch[1]{\renewcommand\@probbatch{#1}}
\newcommand\probno[1]{\renewcommand\@probno{#1}}
\newcommand\probname[1]{\renewcommand\@probname{#1}}
\newcommand\proborigin[1]{\renewcommand\@proborigin{#1}}
\newcommand\probpoints[1]{\renewcommand\@probpoints{#1}}
\newcommand\probsolauthors[1]{\renewcommand\@probsolauthors{{#1}}} % due to foreach expansion
\newcommand\probsolvers[1]{\renewcommand\@probsolvers{#1}}
\newcommand\probavg[1]{\renewcommand\@probavg{#1}}
\newcommand\probtask[1]{\renewcommand\@probtask{#1}}
\newcommand\probsolution[1]{\renewcommand\@probsolution{#1}}
\newcommand\probfig[1]{\renewcommand\@probfig{#1}}