%
% @author Michal Koutn√Ω <michal@fykos.cz>
%
% @description Table macros, especially for typesetting results table.
%              To preprocess CSV data use makefile target results/*.tex.
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{fkstables}[2011/09/11 FYKOS tables]

\RequirePackage{booktabs}
\RequirePackage{tabularx}
\RequirePackage{dcolumn}
\RequirePackage{multirow}
\RequirePackage{rotating}


% used to style whole rows or rows and columns combined
% example header: \begin{tabular}{x{\bfseries}rA{\itshape}l^l^r^r^r^r^r^r^r^rA{\bfseries}rA{\itshape}rA{\bfseries}r}
%                 to highlight row use \rowstyle{<style>}
\newcolumntype{+}{>{\global\let\currentrowstyle\relax}}
\newcolumntype{x}[1]{>{\global\let\currentrowstyle\relax#1}}
\newcolumntype{^}{>{\currentrowstyle}}
\newcolumntype{A}[1]{>{\currentrowstyle#1}}
\newcommand{\rowstyle}[1]{\gdef\currentrowstyle{#1}%
  #1\ignorespaces
}

% for decimal numbers
\newcolumntype{d}[1]{D{.}{,}{#1}}

\met@resultscols % this defines new column type as in fksmeta


\newcounter{RESendline}%
\newcounter{RESinit}%
\newcounter{resultstmp}
\newlength{\RESenddist}
\newbox\RESbox%

\newcommand\resultstab[2][0]{%
%    \ifdim\pagetotal>.9\pagegoal\newpage\fi%
    \setcounter{RESinit}{1}%
    \resultstabR[#1]{#2}%
}

\newcommand\resultsmakebox[2][0]{
    \setbox\RESbox=\hbox{%
        \small\setlength{\tabcolsep}{2pt}%
        \begin{tabularx}{\textwidth}{T}% batch, percent, sum
            \rowstyle{\bfseries}%
            \met@resultsheader%
            \ifthenelse{\equal{#1}{0}}{%
                \input{results/#2.tex}%TODO path
            }{%
%hlavicka u pokracovani
                \ifnum\value{RESinit}=1\else\partialinput{1}{2}{results/#2}\fi%
                \partialinput{\theRESinit}{\theRESendline}{results/#2}%TODO path
            }%
        \end{tabularx}%
    }% end hbox
}

% TODO pretekajici prijmeni/skola

\newcommand\resultstabR[2][0]{%
% vytvoreni boxu s celou tabulkou
    \setcounter{RESendline}{#1}%
    \resultsmakebox[#1]{#2}%
    \setlength{\RESenddist}{\pagetotal}%
    \addtolength{\RESenddist}{\ht\RESbox}%
    \addtolength{\RESenddist}{\dp\RESbox}%
%\dotfill\hspace{\RESenddist}\dotfill\hspace{\pagegoal}\dotfill\\%
% pokud se tam box vejde, vlozi se
    \ifdim\RESenddist<\pagegoal%
        \begin{center}A\box\RESbox\end{center}%
% jinak: urceni poctu radek, co se tam vejdou
    \else%
        \setcounter{RESendline}{1}%
        \setlength{\RESenddist}{\pagetotal}%
        \addtolength{\RESenddist}{10mm}%TODO skvira na spodku stranky
        \loop\ifdim\RESenddist<\pagegoal%
            \small%
            \addtolength{\RESenddist}{\baselineskip}%
            \addtocounter{RESendline}{1}%
        \repeat%
%        \addtocounter{RESendline}{-1}%
%
        \setcounter{resultstmp}{50}%max pocet pretykajicich radek
        \loop\ifnum\theresultstmp>0\addtocounter{resultstmp}{-1}%
            \resultsmakebox[1]{#2}%
	    \setlength{\RESenddist}{\pagetotal}%
            \addtolength{\RESenddist}{\ht\RESbox}%
            \addtolength{\RESenddist}{\dp\RESbox}%
            \addtolength{\RESenddist}{10mm}% TODO stejna skvira
            \ifdim\RESenddist>\pagegoal\addtocounter{RESendline}{-1}\fi%
        \repeat%
%
        \begin{center}B\box\RESbox\end{center}\newpage%
        \ifnum\theRESendline<#1%
            \addtocounter{RESendline}{1}%
            \setcounter{RESinit}{\theRESendline}%
            \resultstabR[#1]{#2}%
        \fi%
    \fi%
}
