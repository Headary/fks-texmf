%
% @author Michal Koutn√Ω <michal@fykos.cz>
%
% @description Table macros, especially for typesetting results table.
%              To preprocess CSV data use makefile target results/*.tex.
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{fkstables}[2011/09/11 FYKOS tables]

\RequirePackage{booktabs}
\RequirePackage{tabularx}
\RequirePackage{dcolumn}
\RequirePackage{multirow}
\RequirePackage{rotating}


% used to style whole rows or rows and columns combined
% example header: \begin{tabular}{x{\bfseries}rA{\itshape}l^l^r^r^r^r^r^r^r^rA{\bfseries}rA{\itshape}rA{\bfseries}r}
%                 to highlight row use \rowstyle{<style>}
\newcolumntype{+}{>{\global\let\currentrowstyle\relax}}
\newcolumntype{x}[1]{>{\global\let\currentrowstyle\relax#1}}
\newcolumntype{^}{>{\currentrowstyle}}
\newcolumntype{A}[1]{>{\currentrowstyle#1}}
\newcommand{\rowstyle}[1]{\gdef\currentrowstyle{#1}%
  #1\ignorespaces
}

% for decimal numbers
\newcolumntype{d}[1]{D{.}{,}{#1}}

\met@resultscols % this defines new column type as in fksmeta


\newcounter{RESendline}%
\newcounter{RESinit}%
\newcounter{resultstmp}
\newlength{\RESenddist}
\newlength{\tableheight}
\newsavebox{\RESbox}%

\newcommand\resultstab[2][0]{%
    \setlength{\tableheight}{\textheight}%
%    \addtolength{\tableheight}{7mm}%
    \ifdim\pagetotal>.8\textwidth\newpage\fi%
    \setcounter{RESinit}{1}%
    \resultstabR[#1]{#2}%
}


\newcommand\resultsmakebox[2][0]{
    \savebox{\RESbox}{\hbox{%
        \small\setlength{\tabcolsep}{2pt}%
        \begin{tabularx}{\textwidth}{T}% batch, percent, sum
            \rowstyle{\bfseries}%
            \met@resultsheader%
            \ifthenelse{\equal{#1}{0}}{%
                \input{results/#2.tex}%TODO path
            }{%
%hlavicka u pokracovani
                \ifnum\value{RESinit}>1\partialinput{1}{2}{results/#2}\fi%
                \partialinput{\theRESinit}{\theRESendline}{results/#2}%TODO path
            }%
        \end{tabularx}%
    }}% end hbox
%  \fi%
}

% TODO pretekajici prijmeni/skola

\newcommand\resultstabR[2][0]{%
% vytvoreni boxu s celou tabulkou
    \setcounter{RESendline}{#1}%
    \addtocounter{RESendline}{-60}%
    \ifnum\theRESendline>\theRESinit\setcounter{RESendline}{\theRESinit}\fi%
    \addtocounter{RESendline}{60}%

    \resultsmakebox[#1]{#2}%
    \setlength{\RESenddist}{\pagetotal}%
    \addtolength{\RESenddist}{\ht\RESbox}%
    \addtolength{\RESenddist}{\dp\RESbox}%
% pokud se tam box vejde, vlozi se
    \ifdim\RESenddist<\tableheight%pagegoal%
        \begin{center}\box\RESbox\end{center}\message{Veslo se (#2).}%
% jinak: urceni poctu radek, co se tam vejdou
    \else%
        \setcounter{resultstmp}{5}%
        \loop\ifnum\theresultstmp>0\addtocounter{resultstmp}{-1}%
            \resultsmakebox[1]{#2}%
	    \setlength{\RESenddist}{\pagetotal}%
            \addtolength{\RESenddist}{\ht\RESbox}%
            \addtolength{\RESenddist}{\dp\RESbox}%
            \addtolength{\RESenddist}{\baselineskip}% TODO stejna skvira
            \ifnum\theRESendline=\theRESinit\setcounter{resultstmp}{-2}\fi%chyba
            \ifdim\RESenddist>\tableheight%
                \addtocounter{RESendline}{-1}%
                \addtocounter{resultstmp}{1}
                \message{D}%
            \fi%
        \repeat%
        \begin{center}\box\RESbox\newpage\end{center}\message{Vesla se pouze cast.(#2)}%
        \ifdim\pagetotal>.8\tableheight\newpage\message{New page:\thepage}\fi%
        \ifnum\theRESendline<#1%
            \addtocounter{RESendline}{1}%
            \setcounter{RESinit}{\theRESendline}%
            \resultstabR[#1]{#2}%
        \fi%
    \fi%
}
